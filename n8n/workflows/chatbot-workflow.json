{
  "name": "Chatbot Inteligente - Manufactura",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-chatbot",
      "name": "Webhook Chatbot",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "chatbot-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Extraer mensaje del usuario\nconst userMessage = $input.item.json.body.message || '';\nconst userId = $input.item.json.body.userId || null;\n\n// Detectar intenciÃ³n\nconst message = userMessage.toLowerCase();\nlet intent = 'general';\nlet productType = null;\n\n// Detectar producto personalizado\nif (message.includes('elaborar') || message.includes('hacer') || message.includes('fabricar')) {\n  intent = 'producto_personalizado';\n  \n  if (message.includes('lavamanos') || message.includes('lavabo')) {\n    productType = 'lavamanos';\n  } else if (message.includes('mueble')) {\n    productType = 'mueble';\n  } else if (message.includes('puerta')) {\n    productType = 'puerta';\n  } else if (message.includes('ventana')) {\n    productType = 'ventana';\n  } else if (message.includes('closet')) {\n    productType = 'closet';\n  } else if (message.includes('cocina')) {\n    productType = 'cocina';\n  }\n}\n\n// Detectar consulta de pedido\nconst orderMatch = userMessage.match(/ORD-\\d{4}-\\d{3}/i);\nif (orderMatch) {\n  intent = 'consulta_pedido';\n}\n\n// Detectar saludo\nif (message.includes('hola') || message.includes('buenos') || message.includes('buenas')) {\n  intent = 'saludo';\n}\n\n// Detectar ayuda\nif (message.includes('ayuda') || message.includes('help')) {\n  intent = 'ayuda';\n}\n\n// Detectar tiempo\nif (message.includes('tiempo') || message.includes('tarda') || message.includes('demora')) {\n  intent = 'tiempo';\n}\n\n// Detectar precio\nif (message.includes('precio') || message.includes('costo') || message.includes('cuanto cuesta')) {\n  intent = 'precio';\n}\n\nreturn {\n  json: {\n    userMessage,\n    userId,\n    intent,\n    productType,\n    orderNumber: orderMatch ? orderMatch[0] : null,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "function-detect-intent",
      "name": "Detectar IntenciÃ³n",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.intent}}",
              "operation": "equals",
              "value2": "producto_personalizado"
            }
          ]
        }
      },
      "id": "if-producto",
      "name": "Â¿Es Producto?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "const productType = $input.item.json.productType || 'producto personalizado';\n\nconst responses = {\n  lavamanos: {\n    message: `Â¡Por supuesto! ğŸ˜Š SÃ­ podemos elaborar muebles de baÃ±o personalizados.\\n\\nPara darte una cotizaciÃ³n precisa, necesito algunos detalles:\\n\\nğŸ“ **Dimensiones**:\\nâ€¢ Ancho\\nâ€¢ Alto\\nâ€¢ Profundidad\\n\\nğŸ“¦ **Cantidad**: Â¿CuÃ¡ntas unidades necesitas?\\n\\nğŸ¨ **Material preferido**: Madera, metal, otro?\\n\\nâ±ï¸ **Urgencia**: Â¿Tienes fecha lÃ­mite?\\n\\nğŸ’¡ Sugerencias:\\nâ€¢ Muebles de baÃ±o personalizados\\nâ€¢ Lavamanos con medidas especiales\\nâ€¢ DiseÃ±os adaptados para niÃ±os\\n\\nÂ¿Puedes darme estos detalles para calcular el tiempo y costo?`,\n    action: 'solicitar_detalles'\n  },\n  mueble: {\n    message: `Â¡Claro que sÃ­! ğŸ˜Š Fabricamos muebles personalizados.\\n\\nPara cotizar necesito:\\n\\nğŸ“ **Dimensiones** (ancho x alto x profundidad)\\nğŸ“¦ **Cantidad**\\nğŸ¨ **Material** (madera, metal, mixto)\\nâ±ï¸ **Urgencia**\\n\\nğŸ’¡ Opciones:\\nâ€¢ Muebles estÃ¡ndar: 8h producciÃ³n\\nâ€¢ Muebles personalizados: 12h producciÃ³n\\n\\nÂ¿Me das los detalles?`,\n    action: 'solicitar_detalles'\n  },\n  default: {\n    message: `Â¡Por supuesto! ğŸ˜Š SÃ­ podemos elaborar ${productType}.\\n\\nPara darte una cotizaciÃ³n precisa, necesito:\\n\\nğŸ“ Dimensiones\\nğŸ“¦ Cantidad\\nğŸ¨ Material\\nâ±ï¸ Urgencia\\n\\nÂ¿Puedes darme estos detalles?`,\n    action: 'solicitar_detalles'\n  }\n};\n\nconst response = responses[productType] || responses.default;\n\nreturn {\n  json: {\n    response: response.message,\n    action: response.action,\n    intent: 'producto_personalizado',\n    productType\n  }\n};"
      },
      "id": "function-response-producto",
      "name": "Respuesta Producto",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.intent}}",
              "operation": "equals",
              "value2": "consulta_pedido"
            }
          ]
        }
      },
      "id": "if-pedido",
      "name": "Â¿Es Consulta Pedido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "url": "http://localhost:3000/api/chatbot/order/={{$json.orderNumber}}",
        "options": {}
      },
      "id": "http-get-order",
      "name": "Buscar Pedido",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "functionCode": "const orderData = $input.item.json;\n\nif (orderData.found) {\n  const order = orderData.order;\n  const statusEmoji = {\n    'Pendiente': 'â³',\n    'En ProducciÃ³n': 'ğŸ”¨',\n    'Completado': 'âœ…',\n    'Entregado': 'ğŸ“¦'\n  }[order.status] || 'ğŸ“‹';\n  \n  return {\n    json: {\n      response: `${statusEmoji} **Pedido ${order.orderNumber}**\\n\\nğŸ‘¤ Cliente: ${order.customer}\\nğŸ“¦ Producto: ${order.product}\\nğŸ“Š Cantidad: ${order.quantity}\\nâ±ï¸ Tiempo estimado: ${order.estimatedTime}h\\nğŸ“… Entrega estimada: ${new Date(order.estimatedDelivery).toLocaleDateString('es-ES')}\\nğŸ”– Estado: **${order.status}**\\n\\nÂ¿Necesitas mÃ¡s informaciÃ³n?`,\n      action: 'pedido_encontrado'\n    }\n  };\n} else {\n  return {\n    json: {\n      response: orderData.message || 'No encontrÃ© ese pedido. Verifica el nÃºmero de orden.',\n      action: 'pedido_no_encontrado'\n    }\n  };\n}"
      },
      "id": "function-format-order",
      "name": "Formatear Pedido",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "functionCode": "const intent = $input.item.json.intent;\n\nconst responses = {\n  saludo: 'Â¡Hola! ğŸ‘‹ Soy tu asistente virtual de manufactura. Puedo ayudarte con:\\n\\nâ€¢ Cotizaciones de productos personalizados\\nâ€¢ Consultar estado de pedidos\\nâ€¢ InformaciÃ³n sobre tiempos de entrega\\nâ€¢ CatÃ¡logo de productos\\n\\nÂ¿QuÃ© necesitas hoy?',\n  \n  ayuda: 'ğŸ¤– **Puedo ayudarte con**:\\n\\n1ï¸âƒ£ **Cotizaciones**\\n   â€¢ Productos personalizados\\n   â€¢ EstimaciÃ³n de tiempos\\n\\n2ï¸âƒ£ **Seguimiento**\\n   â€¢ Estado de pedidos\\n   â€¢ Tiempos de entrega\\n\\n3ï¸âƒ£ **InformaciÃ³n**\\n   â€¢ CatÃ¡logo de productos\\n   â€¢ Capacidades de fabricaciÃ³n\\n\\nğŸ’¬ Solo escribe tu pregunta naturalmente!',\n  \n  tiempo: 'â±ï¸ Los tiempos de entrega dependen de:\\n\\n1. **Tipo de producto**\\n2. **Complejidad del diseÃ±o**\\n3. **Cantidad solicitada**\\n4. **Carga actual de producciÃ³n**\\n\\nğŸ“Š **Tiempos promedio**:\\nâ€¢ Productos estÃ¡ndar: 2-5 dÃ­as\\nâ€¢ Productos personalizados: 5-10 dÃ­as\\nâ€¢ Proyectos grandes: 10-20 dÃ­as\\n\\nğŸ’¡ Para una estimaciÃ³n exacta, ve a **\"Solicitar Producto\"**',\n  \n  precio: 'ğŸ’° Para darte un precio exacto, necesito:\\n\\nğŸ“ **Especificaciones**:\\nâ€¢ Tipo de producto\\nâ€¢ Dimensiones\\nâ€¢ Material\\nâ€¢ Cantidad\\n\\nğŸ“ **Opciones**:\\n1. Usa **\"Solicitar Producto\"** para cotizaciÃ³n automÃ¡tica\\n2. DescrÃ­beme lo que necesitas aquÃ­\\n3. Contacta a ventas: ventas@manufactura.com',\n  \n  general: 'ğŸ’¬ Gracias por tu mensaje.\\n\\nPara ayudarte mejor, puedes:\\n\\n1ï¸âƒ£ Describir quÃ© producto necesitas\\n2ï¸âƒ£ Consultar un pedido con su nÃºmero\\n3ï¸âƒ£ Escribir \"ayuda\" para ver opciones\\n\\nÂ¿QuÃ© necesitas?'\n};\n\nreturn {\n  json: {\n    response: responses[intent] || responses.general,\n    action: 'respuesta_general',\n    intent\n  }\n};"
      },
      "id": "function-general-response",
      "name": "Respuesta General",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "url": "http://localhost:3000/api/chatbot/message",
        "method": "POST",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"message\": \"{{$json.userMessage}}\",\n  \"userId\": {{$json.userId}},\n  \"response\": \"{{$json.response}}\"\n}"
      },
      "id": "http-save-conversation",
      "name": "Guardar ConversaciÃ³n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"response\": \"{{$json.response}}\",\n  \"timestamp\": \"{{$json.timestamp}}\",\n  \"intent\": \"{{$json.intent}}\",\n  \"action\": \"{{$json.action}}\"\n}"
      },
      "id": "respond-to-webhook",
      "name": "Responder al Usuario",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 300]
    }
  ],
  "connections": {
    "Webhook Chatbot": {
      "main": [
        [
          {
            "node": "Detectar IntenciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar IntenciÃ³n": {
      "main": [
        [
          {
            "node": "Â¿Es Producto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿Es Producto?": {
      "main": [
        [
          {
            "node": "Respuesta Producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Â¿Es Consulta Pedido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿Es Consulta Pedido?": {
      "main": [
        [
          {
            "node": "Buscar Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta General",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Pedido": {
      "main": [
        [
          {
            "node": "Formatear Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Pedido": {
      "main": [
        [
          {
            "node": "Guardar ConversaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta Producto": {
      "main": [
        [
          {
            "node": "Guardar ConversaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta General": {
      "main": [
        [
          {
            "node": "Guardar ConversaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar ConversaciÃ³n": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "chatbot-workflow"
}
